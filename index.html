<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–æ–¥–∞—Ä–∫–∏ Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ‚≠ê –ë–∞–ª–∞–Ω—Å –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
  <div class="stars-balance" id="starsBalance">
    <img src="star.png" alt="Stars" />
    <span id="starsAmount">0</span>
    <button class="top-up-button" onclick="buyStars()">+</button>
  </div>
  <div class="container">
    <div id="content">
      <section id="cases" class="section active">
        <h2 class="title">–ö–µ–π—Å—ã</h2>
        <div class="cases-grid">
          <div class="case-container">
            <button class="case-button" onclick="onCaseClick()">
              <img src="cases1.png" alt="–ö–µ–π—Å" />
            </button>
          </div>
          <section id="case-open" class="section">
            <h2 class="title">–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞</h2>
            <div class="open-case-content">
              <img src="cases1.png" alt="–û—Ç–∫—Ä—ã—Ç—ã–π –∫–µ–π—Å" class="case-open-image" />
              <button class="back-button" onclick="navigate('cases')">–ù–∞–∑–∞–¥ –∫ –∫–µ–π—Å–∞–º</button>
            </div>
          </section>
          <!-- –î–æ–ø. –∫–µ–π—Å—ã -->
          <div class="case-container"></div>
          <div class="case-container"></div>
          <div class="case-container"></div>
          <div class="case-container"></div>
          <div class="case-container"></div>
        </div>
      </section>

      <section id="earn" class="section">
        <h2>–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å</h2>
        <p>—Ç—É—Ç –±—É–¥—É—Ç –∑–∞–¥–∞–Ω–∏—è.</p>
      </section>
      <section id="invite" class="section">
        <h2>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h2>
        <p>–¢—É—Ç –±—É–¥—É—Ç –∏–Ω–≤–∞–π—Ç—ã.</p>
      </section>
      <section id="shop" class="section">
        <h2>–ú–∞–≥–∞–∑–∏–Ω –ø–æ–¥–∞—Ä–∫–æ–≤</h2>
        <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –º–∞–≥–∞–∑–∏–Ω –ø–æ–¥–∞—Ä–∫–æ–≤</p>
      </section>
      <section id="profile" class="section">
        <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="profile-card" id="profileCard">
          <img id="userAvatar" class="avatar" src="" alt="avatar" />
          <div class="profile-info">
            <div id="userFullName" class="fullname">–ò–º—è</div>
            <div id="userUsername" class="username">@username</div>
          </div>
        </div>
        <label class="effects-toggle">
          <input type="checkbox" id="effectsToggle" checked/>
          –ê–Ω–∏–º–∞—Ü–∏–∏
        </label>
      </section>
    </div>
  </div>

  <div class="bottom-nav">
    <button onclick="navigate('cases')" class="nav-button active-btn"><img src="case1.png" alt=""></button>
    <button onclick="navigate('earn')" class="nav-button"><img src="Quest.png" alt=""></button>
    <button onclick="navigate('invite')" class="nav-button"><img src="friend1.png" alt=""></button>
    <button onclick="navigate('shop')" class="nav-button"><img src="Store.png" alt=""></button>
    <button onclick="navigate('profile')" class="nav-button"><img src="Profile2.png" alt=""></button>
  </div>

  <!-- üîß Telegram API -->
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const userId = tg?.initDataUnsafe?.user?.id;

    async function loadStarsBalance() {
      if (!userId) return;

      try {
        const res = await fetch(`/api/user-balance?user_id=${userId}`);
        const data = await res.json();
        document.getElementById('starsAmount').textContent = data.balance ?? 0;
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', err);
        document.getElementById('starsAmount').textContent = '‚Äî';
      }
    }

    async function buyStars() {
      if (!userId) {
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }

      try {
        const res = await fetch(`/api/get-stars-invoice?user_id=${userId}`);
        const data = await res.json();

        if (!data.invoice_link) {
          alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á—ë—Ç–∞');
          return;
        }

        tg.openInvoice(data.invoice_link, (status) => {
          if (status === 'paid') {
            loadStarsBalance();
          }
        });
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—á—ë—Ç–∞:', err);
      }
    }

    loadStarsBalance();
  </script>

  <!-- üîß –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
  <script>
    let effectsEnabled = localStorage.getItem('effectsEnabled');
    if (effectsEnabled === null) effectsEnabled = 'true';
    else effectsEnabled = effectsEnabled === 'true';

    const effectsToggle = document.getElementById('effectsToggle');
    effectsToggle.checked = effectsEnabled;

    function setEffectsState(enabled) {
      effectsEnabled = enabled;
      localStorage.setItem('effectsEnabled', enabled);
      document.body.classList.toggle('effects-disabled', !enabled);
    }

    effectsToggle.addEventListener('change', () => {
      setEffectsState(effectsToggle.checked);
    });

    setEffectsState(effectsEnabled);

    let isTransitioning = false;

    function navigate(sectionId) {
      if (isTransitioning) return;

      const currentSection = document.querySelector('.section.active');
      const nextSection = document.getElementById(sectionId);
      if (!nextSection || currentSection.id === sectionId) return;

      isTransitioning = true;

      const buttons = document.querySelectorAll('.nav-button');

      if (effectsEnabled) {
        currentSection.classList.add('fade-out');
        currentSection.classList.remove('fade-in');

        setTimeout(() => {
          currentSection.classList.remove('active', 'fade-out');
          nextSection.classList.add('active', 'fade-in');

          buttons.forEach(btn => btn.classList.remove('active-btn'));
          const targetBtn = Array.from(buttons).find(btn => btn.getAttribute('onclick').includes(sectionId));
          if (targetBtn) targetBtn.classList.add('active-btn');

          setTimeout(() => {
            isTransitioning = false;
          }, 150);
        }, 150);
      } else {
        currentSection.classList.remove('active');
        nextSection.classList.add('active');

        buttons.forEach(btn => btn.classList.remove('active-btn'));
        const targetBtn = Array.from(buttons).find(btn => btn.getAttribute('onclick').includes(sectionId));
        if (targetBtn) targetBtn.classList.add('active-btn');

        isTransitioning = false;
      }
    }

    function onCaseClick() {
      navigate('case-open');
    }
    const plusButton = document.getElementById('starsPlus');

if (plusButton) {
  plusButton.addEventListener('click', () => {
    document.getElementById('starsModal').classList.remove('hidden');
  });
}

function closeStarsModal() {
  document.getElementById('starsModal').classList.add('hidden');
}

function confirmStars() {
  const input = document.getElementById('starsInput');
  const amount = parseInt(input.value, 10);

  if (!amount || amount < 1) {
    alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥");
    return;
  }

  Telegram.WebApp.openInvoice({
    slug: `stars-invoice-${amount}`,
    is_test: true,
  });

  closeStarsModal();
}

  </script>
  <div id="starsModal" class="stars-modal hidden">
  <div class="stars-modal-content">
    <h3>–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥</h3>
    <input type="number" id="starsInput" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 50" />
    <div class="stars-modal-buttons">
      <button onclick="confirmStars()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
      <button onclick="closeStarsModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>
</body>
</html>